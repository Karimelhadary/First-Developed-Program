{% extends "base.html" %}
{% set active='insights' %}
{% block title %}TaskManager — Insights{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-end flex-wrap gap-2 mb-3">
  <div>
    <h1 class="tm-page-title h3 mb-1">Insights</h1>
    <div class="tm-subtitle">A quick look at your week: tasks, focus time, and mood logs.</div>
  </div>
  <div class="tm-subtitle small">Data updates automatically after you complete tasks or timers.</div>
</div>

<div class="row g-3">
  <div class="col-12 col-lg-5">
    <div class="tm-card card p-4">
      <h2 class="h5 mb-3">This week's summary</h2>
      <div id="summary" class="vstack gap-2">
        <div class="tm-kpi"><div class="label">Tasks completed</div><div class="value" id="kpiTasks">—</div></div>
        <div class="tm-kpi"><div class="label">Overall progress</div><div class="value" id="kpiProgress">—</div></div>
        <div class="tm-kpi"><div class="label">Focus time</div><div class="value" id="kpiFocus">—</div></div>
        <div class="tm-kpi"><div class="label">Break time</div><div class="value" id="kpiBreak">—</div></div>
        <div class="tm-kpi"><div class="label">Mood logs</div><div class="value" id="kpiMood">—</div></div>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-7">
    <div class="tm-card card p-4 mb-3">
      <h2 class="h5 mb-3">Tasks overview</h2>
      <canvas id="tasksChart" height="180"></canvas>
    </div>

    <div class="tm-card card p-4">
      <h2 class="h5 mb-3">Focus vs break minutes</h2>
      <canvas id="minutesChart" height="180"></canvas>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  async function loadInsights(){
    const res = await fetch("/api/insights");
    const data = await res.json();

    // summary cards
    document.getElementById("kpiTasks").textContent = `${data.tasks.completed}/${data.tasks.total}`;
    document.getElementById("kpiProgress").textContent = `${data.tasks.progress_pct}%`;
    document.getElementById("kpiFocus").textContent = `${data.timer.focus_minutes}m (${data.timer.focus_sessions} sessions)`;
    document.getElementById("kpiBreak").textContent = `${data.timer.break_minutes}m (${data.timer.break_sessions} sessions)`;
    document.getElementById("kpiMood").textContent = `${data.mood.logs}`;

    // charts
    const tasksCtx = document.getElementById('tasksChart').getContext('2d');
    new Chart(tasksCtx, {
      type: 'doughnut',
      data: {
        labels: ['Completed', 'Remaining'],
        datasets: [{ label: 'Tasks', data: [data.tasks.completed, data.tasks.remaining] }]
      },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });

    const minutesCtx = document.getElementById('minutesChart').getContext('2d');
    new Chart(minutesCtx, {
      type: 'line',
      data: {
        labels: data.charts.labels,
        datasets: [
          { label: 'Focus minutes', data: data.charts.focus_minutes, tension: 0.25 },
          { label: 'Break minutes', data: data.charts.break_minutes, tension: 0.25 }
        ]
      },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });
  }
  loadInsights().catch(console.error);
</script>
{% endblock %}

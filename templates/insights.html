<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Insights — Task Management System</title>

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="{{ url_for('static', filename='insights.css') }}" />
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light mb-3">
  <div class="container-fluid">
    <a class="navbar-brand" href="{{ url_for('splash_bp.splash') }}">TaskManager</a>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" href="{{ url_for('dashboard_bp.dashboard') }}">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('tasks_bp.task_list') }}">Tasks</a></li>
        <li class="nav-item"><a class="nav-link active" href="{{ url_for('insights_bp.insights') }}">Insights</a></li>
      </ul>
    </div>
  </div>
</nav>

<header class="container mb-3">
  <a href="{{ url_for('dashboard_bp.dashboard') }}" class="back">← Dashboard</a>
  <h2>Your Insights</h2>
</header>

<main class="container">
  <section class="summary card p-3 mb-3 shadow-sm" id="summary">
    <h3>This Week's Summary</h3>
    <p>Tasks completed: <strong id="tasks-completed">–</strong></p>
    <p>Overall progress: <strong id="tasks-progress">–</strong></p>
    <p>Focus time: <strong id="focus-time">–</strong> (<span id="focus-sessions">–</span> sessions)</p>
    <p>Break time: <strong id="break-time">–</strong> (<span id="break-sessions">–</span> sessions)</p>
    <p>Mood logs: <strong id="mood-logs">–</strong></p>
  </section>

  <section class="chart card p-3 mb-3 shadow-sm">
    <h3>Tasks Overview</h3>
    <canvas id="tasksChart" width="500" height="250"></canvas>
  </section>

  <section class="chart card p-3 mb-3 shadow-sm">
    <h3>Focus vs Break Minutes (Last 7 days)</h3>
    <canvas id="minutesChart" width="500" height="250"></canvas>
  </section>

  <section class="quote card p-3 shadow-sm">
    <blockquote>“Productivity is never an accident.”</blockquote>
    <p>– Paul J. Meyer</p>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  async function loadInsights() {
    const res = await fetch('/api/insights', { credentials: 'same-origin' });
    const data = await res.json();

    // Summary numbers
    document.getElementById('tasks-completed').textContent = `${data.tasks.completed}/${data.tasks.total}`;
    const pct = data.tasks.total > 0 ? Math.round((data.tasks.completed / data.tasks.total) * 100) : 0;
    document.getElementById('tasks-progress').textContent = `${pct}%`;
    document.getElementById('focus-time').textContent = data.focus.pretty;
    document.getElementById('focus-sessions').textContent = data.focus.sessions;
    document.getElementById('break-time').textContent = data.break.pretty;
    document.getElementById('break-sessions').textContent = data.break.sessions;

    const moodsTotal = Object.values(data.moods).reduce((a,b)=>a+b,0);
    document.getElementById('mood-logs').textContent = moodsTotal;

    // Charts
    const tasksCtx = document.getElementById('tasksChart').getContext('2d');
    new Chart(tasksCtx, {
      type: 'doughnut',
      data: {
        labels: ['Completed', 'Remaining'],
        datasets: [{ label: 'Tasks', data: [data.tasks.completed, data.tasks.remaining] }]
      },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });

    const minutesCtx = document.getElementById('minutesChart').getContext('2d');
    new Chart(minutesCtx, {
      type: 'line',
      data: {
        labels: data.charts.labels,
        datasets: [
          { label: 'Focus minutes', data: data.charts.focus_minutes },
          { label: 'Break minutes', data: data.charts.break_minutes }
        ]
      },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });
  }
  loadInsights().catch(console.error);
</script>
</body>
</html>